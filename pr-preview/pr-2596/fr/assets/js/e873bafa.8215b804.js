"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[53136],{887166:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>i,default:()=>N,frontMatter:()=>c,metadata:()=>p,toc:()=>m});n(667294);var t=n(603905),a=n(451715),s=n(907626);function l(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function o(e,r){return r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):function(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))})),e}function u(e,r){if(null==e)return{};var n,t,a=function(e,r){if(null==e)return{};var n,t,a={},s=Object.keys(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||(a[n]=e[n]);return a}(e,r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const c={id:"upgrade-centreon-ha-from-20-04",title:"Mont\xe9e de version de Centreon HA depuis Centreon 20.04"},i=void 0,p={unversionedId:"upgrade/centreon-ha/upgrade-centreon-ha-from-20-04",id:"version-21.10/upgrade/centreon-ha/upgrade-centreon-ha-from-20-04",title:"Mont\xe9e de version de Centreon HA depuis Centreon 20.04",description:"Ce chapitre d\xe9crit la proc\xe9dure de mont\xe9e de version de votre plateforme",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-21.10/upgrade/centreon-ha/upgrade-from-20-04.md",sourceDirName:"upgrade/centreon-ha",slug:"/upgrade/centreon-ha/upgrade-centreon-ha-from-20-04",permalink:"/centreon-documentation/pr-preview/pr-2596/fr/docs/21.10/upgrade/centreon-ha/upgrade-centreon-ha-from-20-04",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-21.10/upgrade/centreon-ha/upgrade-from-20-04.md",tags:[],version:"21.10",lastUpdatedAt:1694170326,formattedLastUpdatedAt:"8 sept. 2023",frontMatter:{id:"upgrade-centreon-ha-from-20-04",title:"Mont\xe9e de version de Centreon HA depuis Centreon 20.04"},sidebar:"version-21.10/docs",previous:{title:"Mont\xe9e de version depuis Centreon 3.4",permalink:"/centreon-documentation/pr-preview/pr-2596/fr/docs/21.10/upgrade/upgrade-from-3-4"},next:{title:"Mont\xe9e de version de Centreon HA depuis Centreon 20.10",permalink:"/centreon-documentation/pr-preview/pr-2596/fr/docs/21.10/upgrade/centreon-ha/upgrade-centreon-ha-from-20-10"}},d={},m=[{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"Suspension de la gestion des resources par le cluster",id:"suspension-de-la-gestion-des-resources-par-le-cluster",level:3},{value:"Sauvegarde",id:"sauvegarde",level:3},{value:"Mettre \xe0 jour la cl\xe9 de signature RPM",id:"mettre-\xe0-jour-la-cl\xe9-de-signature-rpm",level:3},{value:"Processus de mise \xe0 jour",id:"processus-de-mise-\xe0-jour",level:2},{value:"Mise \xe0 jour des d\xe9p\xf4ts",id:"mise-\xe0-jour-des-d\xe9p\xf4ts",level:3},{value:"Mise \xe0 jour PHP",id:"mise-\xe0-jour-php",level:3},{value:"Mont\xe9e de version de la solution Centreon",id:"mont\xe9e-de-version-de-la-solution-centreon",level:3},{value:"Suppression des crons",id:"suppression-des-crons",level:3},{value:"Changez les permissions pour la resource centreon_central_sync",id:"changez-les-permissions-pour-la-resource-centreon_central_sync",level:3},{value:"Suppression des fichiers &quot;memory&quot; de Broker",id:"suppression-des-fichiers-memory-de-broker",level:3},{value:"Red\xe9marrez les processus Centreon",id:"red\xe9marrez-les-processus-centreon",level:3},{value:"Mont\xe9e de version du serveur MariaDB",id:"mont\xe9e-de-version-du-serveur-mariadb",level:3},{value:"Configurer le slave_parallel_mode",id:"configurer-le-slave_parallel_mode",level:4},{value:"Relancer la r\xe9plication MariaDB",id:"relancer-la-r\xe9plication-mariadb",level:4},{value:"R\xe9tablissement de la gestion des ressources par le cluster",id:"r\xe9tablissement-de-la-gestion-des-ressources-par-le-cluster",level:2},{value:"Contr\xf4le de l&#39;\xe9tat du cluster",id:"contr\xf4le-de-l\xe9tat-du-cluster",level:3},{value:"V\xe9rification de la stabilit\xe9 de la plateforme",id:"v\xe9rification-de-la-stabilit\xe9-de-la-plateforme",level:2}],k={toc:m},v="wrapper";function N(e){var{components:r}=e,n=u(e,["components"]);return(0,t.kt)(v,o(function(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{},t=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),t.forEach((function(r){l(e,r,n[r])}))}return e}({},k,n),{components:r,mdxType:"MDXLayout"}),(0,t.kt)("p",null,"Ce chapitre d\xe9crit la proc\xe9dure de mont\xe9e de version de votre plateforme\nCentreon HA depuis la version 20.04 vers la version 21.10."),(0,t.kt)("h2",{id:"pr\xe9requis"},"Pr\xe9requis"),(0,t.kt)("h3",{id:"suspension-de-la-gestion-des-resources-par-le-cluster"},"Suspension de la gestion des resources par le cluster"),(0,t.kt)("p",null,"Cette op\xe9ration n\xe9cessite de suspendre la gestion des ressources Centreon et MariaDB par le cluster pour \xe9viter qu'une bascule se produise en pleine mise \xe0 jour."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource unmanage centreon\npcs resource unmanage ms_mysql\npcs resource unmanage php7-clone\n")),(0,t.kt)("h3",{id:"sauvegarde"},"Sauvegarde"),(0,t.kt)("p",null,"Avant toute chose, il est pr\xe9f\xe9rable de s\u2019assurer de l\u2019\xe9tat et de la consistance\ndes sauvegardes de l\u2019ensemble des serveurs centraux de votre plate-forme :"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Serveur Centreon Central,"),(0,t.kt)("li",{parentName:"ul"},"Serveur de base de donn\xe9es.")),(0,t.kt)("h3",{id:"mettre-\xe0-jour-la-cl\xe9-de-signature-rpm"},"Mettre \xe0 jour la cl\xe9 de signature RPM"),(0,t.kt)("p",null,"Pour des raisons de s\xe9curit\xe9, les cl\xe9s utilis\xe9es pour signer les RPMs Centreon sont chang\xe9es r\xe9guli\xe8rement. Le dernier changement a eu lieu le 14 octobre 2021. Lorsque vous mettez Centreon \xe0 jour depuis une version plus ancienne, vous devez suivre la ",(0,t.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2596/fr/docs/21.10/security/key-rotation#installation-existante"},"proc\xe9dure de changement de cl\xe9"),", afin de supprimer l'ancienne cl\xe9 et d'installer la nouvelle."),(0,t.kt)("h2",{id:"processus-de-mise-\xe0-jour"},"Processus de mise \xe0 jour"),(0,t.kt)("h3",{id:"mise-\xe0-jour-des-d\xe9p\xf4ts"},"Mise \xe0 jour des d\xe9p\xf4ts"),(0,t.kt)("p",null,"Il est n\xe9cessaire de mettre \xe0 jour le d\xe9p\xf4t Centreon."),(0,t.kt)("p",null,"Ex\xe9cutez la commande suivante :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y https://yum.centreon.com/standard/21.10/el7/stable/noarch/RPMS/centreon-release-21.10-5.el7.centos.noarch.rpm\n")),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},(0,t.kt)("strong",{parentName:"p"},"WARNING:")," pour \xe9viter des probl\xe8mes de d\xe9pendances manquantes, r\xe9f\xe9rez-vous \xe0 la documentation des modules additionnels pour mettre \xe0 jour les d\xe9p\xf4ts Centreon Business")),(0,t.kt)("h3",{id:"mise-\xe0-jour-php"},"Mise \xe0 jour PHP"),(0,t.kt)("p",null,"Centreon 21.10 utilise PHP en version 8.0."),(0,t.kt)("p",null,"Vous devez tout d'abord installer les d\xe9p\xf4ts ",(0,t.kt)("strong",{parentName:"p"},"remi")," :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y yum-utils\nyum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\nyum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm\n")),(0,t.kt)("p",null,"Ensuite, vous devez activer le d\xe9p\xf4t php 8.0"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum-config-manager --enable remi-php80\n")),(0,t.kt)("h3",{id:"mont\xe9e-de-version-de-la-solution-centreon"},"Mont\xe9e de version de la solution Centreon"),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"Assurez-vous que tous les utilisateurs sont d\xe9connect\xe9s avant de commencer\nla proc\xe9dure de mise \xe0 jour.")),(0,t.kt)("p",null,"Videz le cache de yum :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum clean all --enablerepo=*\n")),(0,t.kt)("p",null,"Mettez \xe0 jour l'ensemble des composants :"),(0,t.kt)(a.Z,{groupId:"sync",mdxType:"Tabs"},(0,t.kt)(s.Z,{value:"HA 2 Nodes",label:"HA 2 Nodes",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum remove centreon-ha\nyum update centreon\\*\nyum install centreon-ha-web centreon-ha-common\nmv /etc/centreon-ha/centreon_central_sync.pm.rpmsave /etc/centreon-ha/centreon_central_sync.pm\nmv /etc/centreon-ha/mysql-resources.sh.rpmsave /etc/centreon-ha/mysql-resources.sh\n"))),(0,t.kt)(s.Z,{value:"HA 4 Nodes",label:"HA 4 Nodes",mdxType:"TabItem"},(0,t.kt)("p",null,"Sur les serveurs Centraux:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum remove centreon-ha\nyum update centreon\\*\nyum install centreon-ha-web centreon-ha-common\nmv /etc/centreon-ha/centreon_central_sync.pm.rpmsave /etc/centreon-ha/centreon_central_sync.pm\n")),(0,t.kt)("p",null,"Sur les serveurs de base de donn\xe9es :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum remove centreon-ha\nyum update centreon\\*\nyum install centreon-ha-common\nmv /etc/centreon-ha/mysql-resources.sh.rpmsave /etc/centreon-ha/mysql-resources.sh\n")))),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"Acceptez les nouvelles cl\xe9s GPG des d\xe9p\xf4ts si n\xe9cessaire.")),(0,t.kt)("p",null,"Le fuseau horaire par d\xe9faut de PHP 8 doit \xeatre configur\xe9. Executez la commande suivante :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},'echo "date.timezone = Europe/Paris" >> /etc/php.d/50-centreon.ini\n')),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"Remplacez ",(0,t.kt)("strong",{parentName:"p"},"Europe/Paris")," par votre fuseau horaire. La liste des fuseaux\nhoraires est disponible ",(0,t.kt)("a",{parentName:"p",href:"http://php.net/manual/en/timezones.php"},"ici"),".")),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},(0,t.kt)("strong",{parentName:"p"},"WARNING")," les commandes suivantes ne doivent \xeatre ex\xe9cut\xe9es que sur un seul n\u0153ud du cluster.")),(0,t.kt)(a.Z,{groupId:"sync",mdxType:"Tabs"},(0,t.kt)(s.Z,{value:"HA 2 Nodes",label:"HA 2 Nodes",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource delete php7 --force\npcs resource create "php" \\\n    systemd:php-fpm \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="30s" \\\n    clone\n'))),(0,t.kt)(s.Z,{value:"HA 4 Nodes",label:"HA 4 Nodes",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource delete php7 --force\npcs resource create "php" \\\n    systemd:php-fpm \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="30s" \\\n    clone\npcs constraint location php-clone avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\n')))),(0,t.kt)("p",null,"Une fois les mises \xe0 jour termin\xe9es sur les deux serveurs, il reste \xe0 appliquer la mise \xe0 jour via l'interface web en fermant la session en cours ou en rafraichissant la page de login."),(0,t.kt)("p",null,"En parall\xe8le, sur le central passif, il faut d\xe9placer le r\xe9pertoire \"install\" pour \xe9viter d'afficher \xe0 nouveau l'interface de mise \xe0 jour suite \xe0 une bascule et reg\xe9n\xe9rer le cache Symfony :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"mv /usr/share/centreon/www/install /var/lib/centreon/installs/install-update-YYYY-MM-DD\nsudo -u apache /usr/share/centreon/bin/console cache:clear\n")),(0,t.kt)("h3",{id:"suppression-des-crons"},"Suppression des crons"),(0,t.kt)("p",null,"Les crons sont remis en place lors de la mise \xe0 jour des RPMs. Supprimer les sur les deux n\u0153uds centraux afin d'\xe9viter les executions concurrentes."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"rm /etc/cron.d/centreon\nrm /etc/cron.d/centstorage\nrm /etc/cron.d/centreon-auto-disco\n")),(0,t.kt)("h3",{id:"changez-les-permissions-pour-la-resource-centreon_central_sync"},"Changez les permissions pour la resource centreon_central_sync"),(0,t.kt)("p",null,"La mise \xe0 jour des RPMs \xe0 modifi\xe9 les permissions sur certains fichiers synchronis\xe9s par ",(0,t.kt)("em",{parentName:"p"},"centreon","_","central","_","sync"),". Il est n\xe9cesssaire de les modifier :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},'chmod 775 /var/log/centreon-engine/\nmkdir /var/log/centreon-engine/archives\nchown centreon-engine: /var/log/centreon-engine/archives\nchmod 775 /var/log/centreon-engine/archives/\nfind /var/log/centreon-engine/ -type f -exec chmod 664 {} \\;\nfind /usr/share/centreon/www/img/media -type d -exec chmod 775 {} \\;\nfind /usr/share/centreon/www/img/media -type f \\( ! -iname ".keep" ! -iname ".htaccess" \\) -exec chmod 664 {} \\;\n')),(0,t.kt)("h3",{id:"suppression-des-fichiers-memory-de-broker"},'Suppression des fichiers "memory" de Broker'),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},(0,t.kt)("strong",{parentName:"p"},"WARNING")," ex\xe9cutez uniquement ces commandes sur le n\u0153ud central actif:\nAvant de manager de nouveau le cluster \xe0 l'aide de pcs, pour \xe9viter des probl\xe8mes\nli\xe9s au changement de version majeure, supprimer tous les fichiers ",(0,t.kt)("em",{parentName:"p"},".queue."),",\n",(0,t.kt)("em",{parentName:"p"},".unprocessed.")," ou ",(0,t.kt)("em",{parentName:"p"},".memory.")," avec les commandes suivantes :")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop cbd-sql\nrm -rf /var/lib/centreon-broker/central-broker-master.memory*\nrm -rf /var/lib/centreon-broker/central-broker-master.queue*\nrm -rf /var/lib/centreon-broker/central-broker-master.unprocessed*\nsystemctl start cbd-sql\n")),(0,t.kt)("p",null,"Puis sur le n\u0153ud central passif, ex\xe9cutez les commandes suivantes:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"rm -rf /var/lib/centreon-broker/central-broker-master.memory*\nrm -rf /var/lib/centreon-broker/central-broker-master.queue*\nrm -rf /var/lib/centreon-broker/central-broker-master.unprocessed*\n")),(0,t.kt)("h3",{id:"red\xe9marrez-les-processus-centreon"},"Red\xe9marrez les processus Centreon"),(0,t.kt)("p",null,"Red\xe9marrez les processus sur le n\u0153ud Central actif:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre"},"systemctl restart cbd centengine centreontrapd gorgoned\n")),(0,t.kt)("p",null,"Et sur le n\u0153ud passif:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart cbd\n")),(0,t.kt)("h3",{id:"mont\xe9e-de-version-du-serveur-mariadb"},"Mont\xe9e de version du serveur MariaDB"),(0,t.kt)("p",null,"Les composants MariaDB peuvent maintenant \xeatre mis \xe0 jour."),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"La mise \xe0 jour MariaDB doit d'abord \xeatre execut\xe9e sur le serveur primaire\npuis sur le serveur secondaire.\nDans le cas d'une HA 4 n\u0153euds, la mise \xe0 jour doit \xeatre fait uniquement sur\nles serveurs de base de donn\xe9es.")),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Arr\xeatez le service mariadb :"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"mysqladmin -p shutdown \n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"D\xe9sinstallez la version actuelle :"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"rpm --erase --nodeps --verbose MariaDB-server MariaDB-client MariaDB-shared MariaDB-compat MariaDB-common\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Installez la version 10.5 :"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"yum install MariaDB-server-10.5\\* MariaDB-client-10.5\\* MariaDB-shared-10.5\\* MariaDB-compat-10.5\\* MariaDB-common-10.5\\*\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"\xc9crasez la configuration mariadbd:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"mv /etc/my.cnf.d/server.cnf.rpmsave /etc/my.cnf.d/server.cnf\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"D\xe9marrez le service mariadb :"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"mysqld_safe &\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Lancez le processus de mise \xe0 jour MariaDB :"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"}," mysql_upgrade -u <utilisateur_admin_bdd> -p\n")),(0,t.kt)("p",{parentName:"li"}," Exemple : si votre utilisateur_admin_bdd est ",(0,t.kt)("inlineCode",{parentName:"p"},"root"),", entrez:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre"},"mysql_upgrade -u root -p\n")),(0,t.kt)("blockquote",{parentName:"li"},(0,t.kt)("p",{parentName:"blockquote"},"R\xe9f\xe9rez vous \xe0 la ",(0,t.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/mysql_upgrade/"},"documentation officielle"),"\npour plus d'informations ou si des erreurs apparaissent pendant cette derni\xe8re \xe9tape.")))),(0,t.kt)("h4",{id:"configurer-le-slave_parallel_mode"},"Configurer le slave_parallel_mode"),(0,t.kt)("p",null,"Depuis la version 10.5, le slave_parallel_mode n'est plus param\xe9tr\xe9 \xe0 ",(0,t.kt)("em",{parentName:"p"},"conservative"),".\nIl est n\xe9cessaire de modifier la configuration mysql en \xe9ditant ",(0,t.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf"),":"),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"Sur les 2 serveurs Centraux dans le cas d'une HA 2 n\u0153uds\net sur les 2 serveurs de base de donn\xe9es dans le cas d'une HA 4 n\u0153uds.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"[server]\n...\nslave_parallel_mode=conservative\n...\n")),(0,t.kt)("h4",{id:"relancer-la-r\xe9plication-mariadb"},"Relancer la r\xe9plication MariaDB"),(0,t.kt)("p",null,"Suite \xe0 la mise \xe0 jour de MariaDB, la r\xe9plication MariaDB sera KO.\nPour la relancer, ex\xe9cutez la commande suivante sur le n\u0153ud de bases de donn\xe9es passif pour \xe9craser ses donn\xe9es avec celles du serveur actif. "),(0,t.kt)("p",null,"Il faut donc lancer la commande suivante sur ",(0,t.kt)("strong",{parentName:"p"},"le n\u0153ud de bases de donn\xe9es passif")," :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"mysqladmin -p shutdown\n")),(0,t.kt)("p",null,"V\xe9rifier que le service ",(0,t.kt)("inlineCode",{parentName:"p"},"mysql")," est bien arr\xeat\xe9,la commande suivante ne doit retourner aucune ligne :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"ps -ef | grep mariadb[d]\n")),(0,t.kt)("p",null,"Une fois que le service est bien arr\xeat\xe9 sur ",(0,t.kt)("strong",{parentName:"p"},"le n\u0153ud de bases de donn\xe9es passif"),", lancer le script de synchronisation ",(0,t.kt)("strong",{parentName:"p"},"depuis le n\u0153ud de bases de donn\xe9es actif")," : "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-sync-bigdb.sh\n")),(0,t.kt)("p",null,"R\xe9sultat attendu :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,t.kt)("h2",{id:"r\xe9tablissement-de-la-gestion-des-ressources-par-le-cluster"},"R\xe9tablissement de la gestion des ressources par le cluster"),(0,t.kt)("p",null,"Tous les composants devraient \xe0 pr\xe9sent \xeatre \xe0 jour et fonctionnels, il faut donc r\xe9tablir la gestion des ressources par le cluster :"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource manage centreon\npcs resource manage ms_mysql\n")),(0,t.kt)("p",null,"Il est possible qu'apr\xe8s le r\xe9tablissement de la gestion des ressources par le cluster,\nle thread de r\xe9plication ne soit plus actif ou que des ",(0,t.kt)("em",{parentName:"p"},"failed actions")," soient pr\xe9sentes.\nUn red\xe9marrage de la ressource ",(0,t.kt)("inlineCode",{parentName:"p"},"ms_mysql")," doit permettre d'y rem\xe9dier ainsi qu'un ",(0,t.kt)("em",{parentName:"p"},"cleanup")," des resources."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource restart ms_mysql\npcs resource cleanup centreon\npcs resource cleanup ms_mysql\n")),(0,t.kt)("h3",{id:"contr\xf4le-de-l\xe9tat-du-cluster"},"Contr\xf4le de l'\xe9tat du cluster"),(0,t.kt)("p",null,"Il est possible de suivre l'\xe9tat du cluster en temps r\xe9el via la commande ",(0,t.kt)("inlineCode",{parentName:"p"},"crm_mon")," :"),(0,t.kt)(a.Z,{groupId:"sync",mdxType:"Tabs"},(0,t.kt)(s.Z,{value:"HA 2 Nodes",label:"HA 2 Nodes",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"Stack: corosync\nCurrent DC: @CENTRAL_SLAVE_NAME@ (version 1.1.20-5.el7_7.2-3c4c782f70) - partition with quorum\nLast updated: Thu Feb 20 13:14:17 2020\nLast change: Thu Feb 20 09:25:54 2020 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resources configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_MASTER_NAME@ ]\n     Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n"))),(0,t.kt)(s.Z,{value:"HA 4 Nodes",label:"HA 4 Nodes",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"[...]\n4 nodes configured\n21 resources configured\n\nOnline: [@CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [@DATABASE_MASTER_NAME@]\n     Slaves: [@DATABASE_SLAVE_NAME@]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [@CENTRAL_MASTER@ @CENTRAL_SLAVE_NAME@]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n     vip_mysql       (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [@CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE@]\n")))),(0,t.kt)("h2",{id:"v\xe9rification-de-la-stabilit\xe9-de-la-plateforme"},"V\xe9rification de la stabilit\xe9 de la plateforme"),(0,t.kt)("p",null,"Il est toujours recommand\xe9, apr\xe8s une mise \xe0 jour, de contr\xf4ler que tout fonctionne bien :"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Acc\xe8s aux menus dans l'interface."),(0,t.kt)("li",{parentName:"ul"},"G\xe9n\xe9ration de configuration + reload ou restart de Centreon Engine"),(0,t.kt)("li",{parentName:"ul"},'Plannifier un contr\xf4le imm\xe9diat dans le menu "Monitoring" et contr\xf4ler que c\'est bien pris en compte (dans un d\xe9lai raisonnable). Faire de m\xeame avec un acquittement, un arr\xeat pr\xe9vu...'),(0,t.kt)("li",{parentName:"ul"},"Migrer une ressource ou un groupe de ressources d'un n\u0153ud \xe0 l'autre, rebooter un serveur actif et contr\xf4ler que tout continue de fonctionner (refaire le tests ci-dessus).")))}N.isMDXComponent=!0}}]);