"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[62616],{140268:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>_,contentTitle:()=>l,default:()=>S,frontMatter:()=>c,metadata:()=>d,toc:()=>i});n(667294);var a=n(603905),r=n(451715),o=n(907626);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function A(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function E(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}const c={id:"acceptance-guide",title:"Cluster acceptance guide"},l=void 0,d={unversionedId:"administration/centreon-ha/acceptance-guide",id:"version-22.04/administration/centreon-ha/acceptance-guide",title:"Cluster acceptance guide",description:"Please note that all commands presented in this document are respectively to be run as root unless otherwise stated.",source:"@site/versioned_docs/version-22.04/administration/centreon-ha/acceptance-guide.md",sourceDirName:"administration/centreon-ha",slug:"/administration/centreon-ha/acceptance-guide",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/acceptance-guide",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/versioned_docs/version-22.04/administration/centreon-ha/acceptance-guide.md",tags:[],version:"22.04",lastUpdatedAt:1694006754,formattedLastUpdatedAt:"Sep 6, 2023",frontMatter:{id:"acceptance-guide",title:"Cluster acceptance guide"},sidebar:"version-22.04/docs",previous:{title:"Configuring Autologin",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/connect/autologin"},next:{title:"Monitoring Centreon-HA",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/monitoring-guide"}},_={},i=[{value:"Requirements of the tests",id:"requirements-of-the-tests",level:2},{value:"Check the state of the cluster",id:"check-the-state-of-the-cluster",level:3},{value:"Check the constraints",id:"check-the-constraints",level:3},{value:"Check the status of the database synchronization",id:"check-the-status-of-the-database-synchronization",level:3},{value:"Centreon resource failover",id:"centreon-resource-failover",level:2},{value:"State of the cluster before the failover",id:"state-of-the-cluster-before-the-failover",level:3},{value:"Perform a failover",id:"perform-a-failover",level:3},{value:"Back to the nominal situation",id:"back-to-the-nominal-situation",level:3},{value:"Simulate the loss of the secondary node",id:"simulate-the-loss-of-the-secondary-node",level:2},{value:"Processing",id:"processing",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation",level:3},{value:"Simulate the loss of the primary node",id:"simulate-the-loss-of-the-primary-node",level:2},{value:"Processing",id:"processing-1",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-1",level:3},{value:"Requirements of the tests",id:"requirements-of-the-tests-1",level:2},{value:"Check the state of the cluster",id:"check-the-state-of-the-cluster-1",level:3},{value:"Check the constraints",id:"check-the-constraints-1",level:3},{value:"Check the status of the database synchronization",id:"check-the-status-of-the-database-synchronization-1",level:3},{value:"Centreon resource failover",id:"centreon-resource-failover-1",level:2},{value:"State of the cluster before the failover",id:"state-of-the-cluster-before-the-failover-1",level:3},{value:"Perform a failover",id:"perform-a-failover-1",level:3},{value:"Back to the nominal situation",id:"back-to-the-nominal-situation-1",level:3},{value:"Simulate the loss of the secondary node",id:"simulate-the-loss-of-the-secondary-node-1",level:2},{value:"Processing",id:"processing-2",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-2",level:3},{value:"Simulate the loss of the primary node",id:"simulate-the-loss-of-the-primary-node-1",level:2},{value:"Processing",id:"processing-3",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-3",level:3}],N={toc:i},p="wrapper";function S(e){var{components:t}=e,n=E(e,["components"]);return(0,a.kt)(p,A(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){s(e,t,n[t])}))}return e}({},N,n),{components:t,mdxType:"MDXLayout"}),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Please note that all commands presented in this document are respectively to be run as ",(0,a.kt)("inlineCode",{parentName:"p"},"root")," unless otherwise stated.")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"HA 2 Nodes",label:"HA 2 Nodes",mdxType:"TabItem"},(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This document will refer to parameters that vary from one installation to another (e.g., names and IP addresses of nodes) via. ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/installation/installation-of-centreon-ha/installation-2-nodes#defining-names-and-IP-addresses-of-servers"},"macros defined here"))),(0,a.kt)("h2",{id:"requirements-of-the-tests"},"Requirements of the tests"),(0,a.kt)("p",null,"To verify the proper functioning of your cluster, you will get all the commands to perform a failover test and simulate network failures."),(0,a.kt)("p",null,"It is necessary to check the state of the cluster before performing the acceptance tests. "),(0,a.kt)("h3",{id:"check-the-state-of-the-cluster"},"Check the state of the cluster"),(0,a.kt)("p",null,"To check the general state of the cluster, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8/ Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 11:09:30 2021\nLast change: Fri Jul  9 11:08:57 2021 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_MASTER_NAME@ ]\n     Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Check the resources for ",(0,a.kt)("inlineCode",{parentName:"p"},"Failed")," errors and correct them with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/troubleshooting-guide"},"troubleshooting guide"),".")),(0,a.kt)("h3",{id:"check-the-constraints"},"Check the constraints"),(0,a.kt)("p",null,"To check that there are no ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),", execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs constraint\n")),(0,a.kt)("p",null,"The command should return this:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Location Constraints:\nOrdering Constraints:\nColocation Constraints:\n  centreon with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with centreon (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Location Constraints:\nOrdering Constraints:\nColocation Constraints:\n  centreon with ms_mysql-master (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-master with centreon (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("h3",{id:"check-the-status-of-the-database-synchronization"},"Check the status of the database synchronization"),(0,a.kt)("p",null,"To verify that the database synchronization is working, performs the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization shows ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/operating-guide"},"operating-guide"),".")),(0,a.kt)("h2",{id:"centreon-resource-failover"},"Centreon resource failover"),(0,a.kt)("h3",{id:"state-of-the-cluster-before-the-failover"},"State of the cluster before the failover"),(0,a.kt)("p",null,"Before running a failover test, check the status of the cluster with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 11:24:27 2021\nLast change: Fri Jul  9 11:08:57 2021 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_MASTER_NAME@ ]\n     Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("h3",{id:"perform-a-failover"},"Perform a failover"),(0,a.kt)("p",null,"To move the resources, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource move centreon\n")),(0,a.kt)("p",null,"You can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command to watch the failover as it happens. It will be necessary to use Ctrl+c to exit the command."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Warning: The ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource move centreon")," command sets an ",(0,a.kt)("inlineCode",{parentName:"p"},"-INFINITY")," constraint on the node hosting the resource, no longer allowed to be running on that node.")),(0,a.kt)("p",null,"As a result, the resources move to another node. Following this manipulation, it is, thus, necessary to execute the command ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource clear centreon")," to ensure the resources can be moved back to this node in the future."),(0,a.kt)("p",null,"To verify that the resources have moved to the second node, performs the command: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):         Started Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):      Started Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 11:38:32 2021\nLast change: Fri Jul  9 11:37:55 2021 by root via crm_attribute on @CENTRAL_SLAVE_NAME@\n    \n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_SLAVE_NAME@ ]\n     Slaves: [ @CENTRAL_MASTER_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"You may notice that like the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," resources, the secondary node has also been promoted to ",(0,a.kt)("inlineCode",{parentName:"p"},"master")," for the ",(0,a.kt)("inlineCode",{parentName:"p"},"ms_mysql")," resource. This behavior is intended and due to ",(0,a.kt)("inlineCode",{parentName:"p"},"Colocation Constraints")," between the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," resources and ",(0,a.kt)("inlineCode",{parentName:"p"},"msq_mysql"),"."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"Colocation Constraints")," are unfound on a 4-node cluster!")),(0,a.kt)("p",null,"Once the failover is completed, execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This will remove the constraints established during the failover.")),(0,a.kt)("p",null,"Also, check that MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization has ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/operating-guide"},"operating-guide"),".")),(0,a.kt)("h3",{id:"back-to-the-nominal-situation"},"Back to the nominal situation"),(0,a.kt)("p",null,"To return to the nominal situation, you must launch the resource failover."),(0,a.kt)("p",null,"Execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The output should be:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):         Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):          Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):       Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):          Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 11:38:32 2021\nLast change: Fri Jul  9 11:37:55 2021 by root via crm_attribute on @CENTRAL_SLAVE_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_SLAVE_NAME@ ]\n     Slaves: [ @CENTRAL_MASTER_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"Then, run the constraint cleanup command in case you have ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Then, execute the failover command: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource move centreon\n")),(0,a.kt)("p",null,"As before, you can follow the failover with the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command."),(0,a.kt)("p",null,"Finally, remove the constraints with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("h2",{id:"simulate-the-loss-of-the-secondary-node"},"Simulate the loss of the secondary node"),(0,a.kt)("p",null,"To simulate a network failure that would isolate the secondary node, you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," to drop traffic from and to the secondary node.\nThe secondary node will be completely excluded from the cluster. The primary node keeps the majority with the QDevice."),(0,a.kt)("h3",{id:"processing"},"Processing"),(0,a.kt)("p",null,"To perform this test, launch the ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," commands on the primary node:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -A INPUT -s @IP_SECONDARY_NODE@ -j DROP\niptables -A OUTPUT -d @IP_SECONDARY_NODE@ -j DROP\n")),(0,a.kt)("p",null,"Executing the command results in no active resources being seen on the secondary node and the primary node being seen as ",(0,a.kt)("inlineCode",{parentName:"p"},"offline"),":"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_SLAVE_NAME@ ]\n  * OFFLINE: [ @CENTRAL_MASTER_NAME@ ]\nNo active resources\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_SLAVE_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition WITHOUT quorum\nLast updated: Fri Jul  9 16:11:53 2021\nLast change: Fri Jul  9 16:06:34 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_MASTER_NAME@ ]\n\nNo active resources\n")))),(0,a.kt)("p",null,"The resources and the cluster are still working by performing a ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs status")," on the primary node.\nThe secondary node is seen ",(0,a.kt)("inlineCode",{parentName:"p"},"offline")," on the primary."),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ ]\n  * OFFLINE: [ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 16:19:03 2021\nLast change: Fri Jul  9 16:05:26 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ ]\nOFFLINE: [ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_MASTER_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("h3",{id:"back-to-nominal-situation"},"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -D INPUT @RULE_NUMBER@\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"The secondary node is again seen ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," by the cluster:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 17:12:39 2021\nLast change: Fri Jul  9 16:06:34 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_MASTER_NAME@ ]\n     Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("p",null,"Also check MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The order must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",{id:"simulate-the-loss-of-the-primary-node"},"Simulate the loss of the primary node"),(0,a.kt)("h3",{id:"processing-1"},"Processing"),(0,a.kt)("p",null,"To perform this test, run the commands on the primary server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -A INPUT -s @IP_SECONDARY_NODE@ -j DROP \niptables -A OUTPUT -d @IP_SECONDARY_NODE@ -j DROP \niptables -A INPUT -s @QDEVICE_IP@ -j DROP \niptables -A OUTPUT -d @QDEVICE_IP@  -j DROP\n")),(0,a.kt)("p",null,"Resources on the primary node should stop and should start on the secondary node. You can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command on the secondary node to watch the startup of resources:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_SLAVE_NAME@ ]\n  * OFFLINE [ @CENTRAL_MASTER_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Fri Jul  9 15:14:00 2021\nLast change: Fri Jul  9 15:11:35 2021 by root via crm_resource on @CENTRAL_SLAVE_NAME@\n\n2 nodes configured\n14 resource instances configured\n\nOnline: [ @CENTRAL_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_MASTER_NAME@ ]\n\nActive resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"This test checks that resources will be switched to the secondary node if the primary node is unavailable and allows for continuity of service."),(0,a.kt)("h3",{id:"back-to-nominal-situation-1"},"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\nDROP       all  --  @QDEVICE_NAME@      anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\nDROP       all  --  anywhere             @QDEVICE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -D INPUT @RULE_NUMBER@;\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"By running the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon")," command on the second node, you will see the primary node move up in the cluster.\nIf you want to switch to the primary node, run the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/acceptance-guide#return-to-nominal-situation"},"failover commands"),".")),(0,a.kt)(o.Z,{value:"HA 4 Nodes",label:"HA 4 Nodes",mdxType:"TabItem"},(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This document will refer to parameters that vary from one installation to another (e.g., names and IP addresses of nodes) via. ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/installation/installation-of-centreon-ha/installation-4-nodes#defining-names-and-IP-addresses-of-servers"},"macros defined here"))),(0,a.kt)("h2",{id:"requirements-of-the-tests-1"},"Requirements of the tests"),(0,a.kt)("p",null,"To verify the proper functioning of your cluster, you will get all the commands to perform a failover test and simulate network failures."),(0,a.kt)("p",null,"It is necessary to check the state of the cluster before performing the acceptance tests. "),(0,a.kt)("h3",{id:"check-the-state-of-the-cluster-1"},"Check the state of the cluster"),(0,a.kt)("p",null,"To check the general state of the cluster, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8/ Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Check the resources for ",(0,a.kt)("inlineCode",{parentName:"p"},"Failed")," errors and correct them with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/troubleshooting-guide"},"troubleshooting guide"),".")),(0,a.kt)("h3",{id:"check-the-constraints-1"},"Check the constraints"),(0,a.kt)("p",null,"To check that there are no ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),", execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs constraint\n")),(0,a.kt)("p",null,"The command should return this:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Location Constraints:\n  Resource: cbd_rrd-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: centreon\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: ms_mysql-clone\n    Disabled on: @CENTRAL_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: php-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\nOrdering Constraints:\n  stop centreon then demote ms_mysql-clone (kind:Mandatory)\nColocation Constraints:\n  ms_mysql-clone with vip_mysql (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Location Constraints:\n  Resource: cbd_rrd-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: centreon\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: ms_mysql-master\n    Disabled on: @CENTRAL_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: php-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\nOrdering Constraints:\n  stop centreon then demote ms_mysql-master (kind:Mandatory)\nColocation Constraints:\n  ms_mysql-master with vip_mysql (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("h3",{id:"check-the-status-of-the-database-synchronization-1"},"Check the status of the database synchronization"),(0,a.kt)("p",null,"To verify that the database synchronization is working, performs the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Connection Status '@DATABASE_MASTER_NAME@' [OK]\nConnection Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization shows ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/operating-guide"},"operating-guide"),".")),(0,a.kt)("h2",{id:"centreon-resource-failover-1"},"Centreon resource failover"),(0,a.kt)("h3",{id:"state-of-the-cluster-before-the-failover-1"},"State of the cluster before the failover"),(0,a.kt)("p",null,"Before running a failover test, check the status of the cluster with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("h3",{id:"perform-a-failover-1"},"Perform a failover"),(0,a.kt)("p",null,"To move the resources, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource move centreon\n")),(0,a.kt)("p",null,"You can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command to watch the failover as it happens. It will be necessary to use Ctrl+c to exit the command."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Warning: The ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource move centreon")," command sets an ",(0,a.kt)("inlineCode",{parentName:"p"},"-INFINITY")," constraint on the node hosting the resource, no longer allowed to be running on that node.")),(0,a.kt)("p",null,"As a result, the resources move to another node. Following this manipulation, it is, thus, necessary to execute the command ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource clear centreon")," to ensure the resources can be moved back to this node in the future."),(0,a.kt)("p",null,"To verify that the resources have moved to the second node, performs the command: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Once the failover is completed, execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This will remove the constraints established during the failover.")),(0,a.kt)("p",null,"Also, check that MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization has ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/operating-guide"},"operating-guide"),".")),(0,a.kt)("h3",{id:"back-to-the-nominal-situation-1"},"Back to the nominal situation"),(0,a.kt)("p",null,"To return to the nominal situation, you must launch the resource failover."),(0,a.kt)("p",null,"Execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs status\n")),(0,a.kt)("p",null,"The output should be:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Then, run the constraint cleanup command in case you have ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Then, execute the failover command: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource move centreon\n")),(0,a.kt)("p",null,"As before, you can follow the failover with the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command."),(0,a.kt)("p",null,"Finally, remove the constraints with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource clear centreon\n")),(0,a.kt)("h2",{id:"simulate-the-loss-of-the-secondary-node-1"},"Simulate the loss of the secondary node"),(0,a.kt)("p",null,"To simulate a network failure that would isolate the @CENTRAL_SLAVE_NAME@, you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," to drop traffic from and to the @CENTRAL_SLAVE_NAME@.\nThe @CENTRAL_SLAVE_NAME@ will be completely excluded from the cluster. The @CENTRAL_MASTER_NAME@ keeps the majority with the QDevice."),(0,a.kt)("h3",{id:"processing-2"},"Processing"),(0,a.kt)("p",null,"To perform this test, launch the ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," commands on the @CENTRAL_SLAVE_NAME@. Be carreful avoid @CENTRAL_SLAVE_IPADDR@ otherwise you loose SSH connection on this node."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -A INPUT -s @CENTRAL_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @CENTRAL_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @QDEVICE_IPADDR@ -j DROP\niptables -A OUTPUT -d @QDEVICE_IPADDR@ -j DROP\n")),(0,a.kt)("p",null,"Executing the command results in no active resources being seen on the secondary node and the primary node being seen as ",(0,a.kt)("inlineCode",{parentName:"p"},"offline"),".\nThe resources and the cluster are still working by performing a ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs status")," on the primary node."),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 10:34:05 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 10:34:05 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("h3",{id:"back-to-nominal-situation-2"},"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -D INPUT @RULE_NUMBER@\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"The secondary node is again seen ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," by the cluster:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Also check MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The order must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@DATABASE_MASTER_NAME@' [OK]\nConnection Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",{id:"simulate-the-loss-of-the-primary-node-1"},"Simulate the loss of the primary node"),(0,a.kt)("h3",{id:"processing-3"},"Processing"),(0,a.kt)("p",null,"To perform this test, run the commands on the @CENTRAL_MASTER_NAME@:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -A INPUT -s @CENTRAL_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @CENTRAL_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @QDEVICE_IPADDR@ -j DROP\niptables -A OUTPUT -d @QDEVICE_IPADDR@ -j DROP\n")),(0,a.kt)("p",null,"Resources on the @CENTRAL_MASTER_NAME@ should stop and should start on the @CENTRAL_SLAVE_NAME@. You can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command on the @CENTRAL_SLAVE_NAME@ to watch the startup of resources:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 11:06:38 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_MASTER_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nvip_mysql       (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nMigration Summary:\n* Node @DATABASE_MASTER_NAME@:\n* Node @CENTRAL_SLAVE_NAME@:\n* Node @DATABASE_SLAVE_NAME@:\n"))),(0,a.kt)(o.Z,{value:"RHEL 7 / CentOS 7",label:"RHEL 7 / CentOS 7",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 11:06:38 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_MASTER_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nvip_mysql       (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nMigration Summary:\n* Node @DATABASE_MASTER_NAME@:\n* Node @CENTRAL_SLAVE_NAME@:\n* Node @DATABASE_SLAVE_NAME@:\n")))),(0,a.kt)("p",null,"This test checks that resources will be switched to the secondary node if the primary node is unavailable and allows for continuity of service."),(0,a.kt)("h3",{id:"back-to-nominal-situation-3"},"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@  anywhere\nDROP       all  --  @DATABASE_MASTER_NAME@  anywhere\nDROP       all  --  @DATABASE_SLAVE_NAME@  anywhere\nDROP       all  --  @QDEVICE_NAME@  anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\nDROP       all  --  anywhere             @DATABASE_MASTER_NAME@\nDROP       all  --  anywhere             @DATABASE_SLAVE_NAME@\nDROP       all  --  anywhere             @QDEVICE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -D INPUT @RULE_NUMBER@;\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"By running the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon")," command on the second node, you will see the primary node move up in the cluster.\nIf you want to switch to the primary node, run the ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.04/administration/centreon-ha/acceptance-guide#return-to-nominal-situation"},"failover commands"),"."))))}S.isMDXComponent=!0}}]);