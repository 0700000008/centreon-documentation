"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[90694],{603905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var r=n(667294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=p(n),d=a,h=c["".concat(s,".").concat(d)]||c[d]||m[d]||o;return n?r.createElement(h,l(l({ref:t},u),{},{components:n})):r.createElement(h,l({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[c]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},198166:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>p,toc:()=>c});n(667294);var r=n(603905);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const i={id:"upgrade-from-3-4",title:"Upgrade from Centreon 3.4"},s=void 0,p={unversionedId:"upgrade/upgrade-from-3-4",id:"version-22.10/upgrade/upgrade-from-3-4",title:"Upgrade from Centreon 3.4",description:"This chapter describes how to upgrade your Centreon platform from version 3.4",source:"@site/versioned_docs/version-22.10/upgrade/upgrade-from-3-4.md",sourceDirName:"upgrade",slug:"/upgrade/upgrade-from-3-4",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/upgrade/upgrade-from-3-4",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/versioned_docs/version-22.10/upgrade/upgrade-from-3-4.md",tags:[],version:"22.10",lastUpdatedAt:1694071479,formattedLastUpdatedAt:"Sep 7, 2023",frontMatter:{id:"upgrade-from-3-4",title:"Upgrade from Centreon 3.4"},sidebar:"version-22.10/docs",previous:{title:"Upgrade from Centreon 18.10",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/upgrade/upgrade-from-18-10"},next:{title:"Upgrade Centreon HA from Centreon 20.04",permalink:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/upgrade/centreon-ha/upgrade-centreon-ha-from-20-04"}},u={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Perform a backup",id:"perform-a-backup",level:3},{value:"Update the RPM signing key",id:"update-the-rpm-signing-key",level:3},{value:"Upgrade the Centreon central server",id:"upgrade-the-centreon-central-server",level:2},{value:"Install Redhat Software Collections repository",id:"install-redhat-software-collections-repository",level:3},{value:"Install the MariaDB repository",id:"install-the-mariadb-repository",level:3},{value:"Upgrade PHP",id:"upgrade-php",level:3},{value:"Upgrade the Centreon solution",id:"upgrade-the-centreon-solution",level:3},{value:"Update your customized Apache configuration",id:"update-your-customized-apache-configuration",level:3},{value:"Customized Apache configuration: enable text compression",id:"customized-apache-configuration-enable-text-compression",level:4},{value:"Additional actions",id:"additional-actions",level:3},{value:"Update the Apache web server",id:"update-the-apache-web-server",level:4},{value:"Configure Apache API access",id:"configure-apache-api-access",level:4},{value:"Upgrade the MariaDB server",id:"upgrade-the-mariadb-server",level:3},{value:"Update the Centreon repository",id:"update-the-centreon-repository",level:4},{value:"Configuration",id:"configuration",level:4},{value:"Upgrading MariaDB",id:"upgrading-mariadb",level:4},{value:"Enable MariaDB on startup",id:"enable-mariadb-on-startup",level:4},{value:"Change the format of the tables",id:"change-the-format-of-the-tables",level:3},{value:"Synchronize the plugins",id:"synchronize-the-plugins",level:3},{value:"Finalizing the upgrade",id:"finalizing-the-upgrade",level:3},{value:"Post-upgrade actions",id:"post-upgrade-actions",level:3},{value:"Upgrade extensions",id:"upgrade-extensions",level:4},{value:"Start the tasks manager",id:"start-the-tasks-manager",level:4},{value:"Remove &quot;Failover name&quot; from the broker outputs&#39; configuration",id:"remove-failover-name-from-the-broker-outputs-configuration",level:4},{value:"Restart monitoring processes",id:"restart-monitoring-processes",level:4},{value:"Upgrade the Pollers",id:"upgrade-the-pollers",level:2},{value:"Update the Centreon repository",id:"update-the-centreon-repository-1",level:3},{value:"Upgrade the Centreon solution",id:"upgrade-the-centreon-solution-1",level:3},{value:"Post-upgrade actions",id:"post-upgrade-actions-1",level:3},{value:"Migrate Centreon Poller Display to Remote Server",id:"migrate-centreon-poller-display-to-remote-server",level:2},{value:"Communications",id:"communications",level:2},{value:"Secure your platform",id:"secure-your-platform",level:2}],m={toc:c},d="wrapper";function h(e){var{components:t}=e,i=l(e,["components"]);return(0,r.kt)(d,o(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){a(e,t,n[t])}))}return e}({},m,i),{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This chapter describes how to upgrade your Centreon platform from version 3.4\n(Centreon Web 2.8) to version 22.10."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"When you upgrade your central server, make sure you also upgrade all your remote servers and your pollers. All servers in your architecture must have the same version of Centreon. In addition, all servers must use the same ",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/developer/developer-broker-bbdo#switching-versions-of-bbdo"},"version of the BBDO protocol"),".")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"This procedure only applies to Centreon platforms installed from Centreon 3.4\npackages on CentOS ",(0,r.kt)("strong",{parentName:"p"},"version 7")," distributions."),(0,r.kt)("p",{parentName:"blockquote"},"If this is not the case, refer to the\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/migrate/migrate-from-3-4"},"migration procedure"),".")),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("h3",{id:"perform-a-backup"},"Perform a backup"),(0,r.kt)("p",null,"Be sure that you have fully backed up your environment for the following\nservers:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Central server"),(0,r.kt)("li",{parentName:"ul"},"Database server")),(0,r.kt)("h3",{id:"update-the-rpm-signing-key"},"Update the RPM signing key"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"For security reasons, the keys used to sign Centreon RPMs are rotated regularly. The last change occurred on October 14, 2021. When upgrading from an older version, you need to go through the ",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/security/key-rotation#existing-installation"},"key rotation procedure"),", to remove the old key and install the new one.")),(0,r.kt)("h2",{id:"upgrade-the-centreon-central-server"},"Upgrade the Centreon central server"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Since 21.04, Centreon uses ",(0,r.kt)("strong",{parentName:"p"},"MariaDB 10.5"),"."),(0,r.kt)("p",{parentName:"blockquote"},"This upgrade process will only upgrade Centreon components first."),(0,r.kt)("p",{parentName:"blockquote"},"MariaDB will be upgraded afterwards.")),(0,r.kt)("h3",{id:"install-redhat-software-collections-repository"},"Install Redhat Software Collections repository"),(0,r.kt)("p",null,"Run the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y https://yum.centreon.com/standard/22.10/el7/stable/noarch/RPMS/centreon-release-22.10-1.el7.centos.noarch.rpm\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you are using a CentOS environment, you must install the ",(0,r.kt)("em",{parentName:"p"},"Software\nCollections")," repositories with the following command:"),(0,r.kt)("pre",{parentName:"blockquote"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y centos-release-scl-rh\n"))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you have an offline license, install the corresponding repository for the plugin packs.\nIf you are using a Business edition, install the correct Business repository too.\nYou can find the repositories on the ",(0,r.kt)("a",{parentName:"p",href:"https://support.centreon.com/hc/en-us/categories/10341239833105-Repositories"},"support portal"),".")),(0,r.kt)("h3",{id:"install-the-mariadb-repository"},"Install the MariaDB repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /tmp\ncurl -JO https://downloads.mariadb.com/MariaDB/mariadb_repo_setup\nbash ./mariadb_repo_setup\nsed -ri 's/1[0-1]\\.[0-9]+/10.5/' /etc/yum.repos.d/mariadb.repo\nrm -f ./mariadb_repo_setup\n")),(0,r.kt)("h3",{id:"upgrade-php"},"Upgrade PHP"),(0,r.kt)("p",null,"Centreon 22.10 uses PHP in version 8.1."),(0,r.kt)("p",null,"First, you need to install the ",(0,r.kt)("strong",{parentName:"p"},"remi")," repository:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y yum-utils\nyum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\nyum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm\n")),(0,r.kt)("p",null,"Then, you need to enable the php 8.1 repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum-config-manager --enable remi-php81\n")),(0,r.kt)("h3",{id:"upgrade-the-centreon-solution"},"Upgrade the Centreon solution"),(0,r.kt)("p",null,"If you have installed Business extensions, update the Business repository to version 22.10.\nVisit the ",(0,r.kt)("a",{parentName:"p",href:"https://support.centreon.com/hc/en-us/categories/10341239833105-Repositories"},"support portal")," to get its address."),(0,r.kt)("p",null,"Stop the Centreon Broker process:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl stop cbd\n")),(0,r.kt)("p",null,"Delete existing retention files:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"rm /var/lib/centreon-broker/* -f\n")),(0,r.kt)("p",null,"Clean yum cache:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum clean all --enablerepo=*\n")),(0,r.kt)("p",null,"Upgrade all the components with the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum update centreon\\* php-pecl-gnupg\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Accept new GPG keys from the repositories as needed.")),(0,r.kt)("p",null,"Enable and start the ",(0,r.kt)("strong",{parentName:"p"},"gorgoned")," service:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl enable gorgoned\nsystemctl start gorgoned\n")),(0,r.kt)("p",null,"The PHP timezone should be set. Run the command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'echo "date.timezone = Europe/Paris" >> /etc/php.d/50-centreon.ini\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Replace ",(0,r.kt)("strong",{parentName:"p"},"Europe/Paris")," by your time zone. You can find the list of\nsupported time zones ",(0,r.kt)("a",{parentName:"p",href:"http://php.net/manual/en/timezones.php"},"here"),".")),(0,r.kt)("p",null,"Execute the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl enable php-fpm\nsystemctl start php-fpm\n")),(0,r.kt)("p",null,"Run the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl status php-fpm\n")),(0,r.kt)("p",null,"You may get the following error:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"Failed loading /usr/lib64/php/modules/ZendGuardLoader.so: /usr/lib64/php/modules/ZendGuardLoader.so: undefined symbol: _zval_ptr_dtor\n")),(0,r.kt)("p",null,"If you do, run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum remove php-zend-guard-loader\n")),(0,r.kt)("h3",{id:"update-your-customized-apache-configuration"},"Update your customized Apache configuration"),(0,r.kt)("p",null,"This section only applies if you customized your Apache configuration. When upgrading your platform, the Apache configuration file is not upgraded automatically: the new configuration file brought by the rpm does not replace the old file. You must copy the changes manually to your customized configuration file."),(0,r.kt)("p",null,"Run a diff between the old and the new Apache configuration files:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"diff -u /opt/rh/httpd24/root/etc/httpd/conf.d/10-centreon.conf /opt/rh/httpd24/root/etc/httpd/conf.d/10-centreon.conf.rpmnew\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"10-centreon.conf")," (post upgrade): this file contains the custom configuration. It does not contain anthing new brought by the upgrade, e.g. the ",(0,r.kt)("strong",{parentName:"li"},"authentication")," string in the ",(0,r.kt)("strong",{parentName:"li"},"LocationMatch")," directive"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"10-centreon.conf.rpmnew")," (post upgrade): this file is provided by the rpm; it contains the ",(0,r.kt)("strong",{parentName:"li"},"authentication")," string, but does not contain any custom configuration.")),(0,r.kt)("p",null,"For each difference between the files, assess whether you should copy it from ",(0,r.kt)("strong",{parentName:"p"},"10-centreon.conf.rpmnew")," to ",(0,r.kt)("strong",{parentName:"p"},"10-centreon.conf"),"."),(0,r.kt)("p",null,"In particular, make sure your customized Apache configuration contains the following directive (with ",(0,r.kt)("strong",{parentName:"p"},"authentication"),")."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'<LocationMatch ^\\${base_uri}/?(authentication|api/(latest|beta|v[0-9]+|v[0-9]+\\.[0-9]+))/.*$>\n    ProxyPassMatch "fcgi://127.0.0.1:9042${install_dir}/api/index.php/$1"\n</LocationMatch>\n')),(0,r.kt)("h4",{id:"customized-apache-configuration-enable-text-compression"},"Customized Apache configuration: enable text compression"),(0,r.kt)("p",null,"In order to improve page loading speed, you can activate text compression on the Apache server. It requires the ",(0,r.kt)("strong",{parentName:"p"},"brotli")," package to work. This is optional but it provides a better user experience."),(0,r.kt)("p",null,"Add the following code to your Apache configuration file, in both the ",(0,r.kt)("inlineCode",{parentName:"p"},"<VirtualHost *:80>")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"<VirtualHost *:443>")," elements:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"<IfModule mod_brotli.c>\n    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json\n</IfModule>\nAddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json\n")),(0,r.kt)("h3",{id:"additional-actions"},"Additional actions"),(0,r.kt)("h4",{id:"update-the-apache-web-server"},"Update the Apache web server"),(0,r.kt)("p",null,"Since 20.04, Centreon uses a new version of Apache web server."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you made manual configuration, please report it into\n",(0,r.kt)("strong",{parentName:"p"},"/opt/rh/httpd24/root/etc/httpd/conf.d/"),".")),(0,r.kt)("p",null,"If SSL mode was enabled, execute command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install httpd24-mod_ssl\n")),(0,r.kt)("p",null,"Then, run the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl disable httpd\nsystemctl stop httpd\nsystemctl enable httpd24-httpd\nsystemctl start httpd24-httpd\n")),(0,r.kt)("h4",{id:"configure-apache-api-access"},"Configure Apache API access"),(0,r.kt)("p",null,"If you had a custom apache configuration, upgrade process through RPM did not update it."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you use https, you can follow\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/administration/secure-platform#enable-https-on-the-web-server"},"this procedure"))),(0,r.kt)("p",null,"You'll then need to add API access section to your configuration file:\n",(0,r.kt)("strong",{parentName:"p"},"/opt/rh/httpd24/root/etc/httpd/conf.d/10-centreon.conf")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-apacheconf"},'Define base_uri "/centreon"\nDefine install_dir "/usr/share/centreon"\n\nServerTokens Prod\n\n<VirtualHost *:80>\n    Header set X-Frame-Options: "sameorigin"\n    Header always edit Set-Cookie ^(.*)$ $1;HttpOnly\n    ServerSignature Off\n    TraceEnable Off\n\n    Alias ${base_uri}/api ${install_dir}\n    Alias ${base_uri} ${install_dir}/www/\n\n    <LocationMatch ^\\${base_uri}/?(?!api/latest/|api/beta/|api/v[0-9]+/|api/v[0-9]+\\.[0-9]+/)(.*\\.php(/.*)?)$>\n        ProxyPassMatch "fcgi://127.0.0.1:9042${install_dir}/www/$1"\n    </LocationMatch>\n\n    <LocationMatch ^\\${base_uri}/?(authentication|api/(latest|beta|v[0-9]+|v[0-9]+\\.[0-9]+))/.*$>\n        ProxyPassMatch "fcgi://127.0.0.1:9042${install_dir}/api/index.php/$1"\n    </LocationMatch>\n\n    ProxyTimeout 300\n    ErrorDocument 404 ${base_uri}/index.html\n    Options -Indexes +FollowSymLinks\n\n    <IfModule mod_security2.c>\n        # https://github.com/SpiderLabs/ModSecurity/issues/652\n        SecRuleRemoveById 200003\n    </IfModule>\n\n    <Directory "${install_dir}/www">\n        DirectoryIndex index.php\n        AllowOverride none\n        Require all granted\n        FallbackResource ${base_uri}/index.html\n    </Directory>\n\n    <Directory "${install_dir}/api">\n        AllowOverride none\n        Require all granted\n    </Directory>\n\n    <If "\'${base_uri}\' != \'/\'">\n        RedirectMatch ^/$ ${base_uri}\n    </If>\n</VirtualHost>\n')),(0,r.kt)("p",null,"Then, restart apache service :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart httpd24-httpd\n")),(0,r.kt)("h3",{id:"upgrade-the-mariadb-server"},"Upgrade the MariaDB server"),(0,r.kt)("p",null,"The MariaDB components can now be upgraded."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Refer to the official MariaDB documentation to know more about this process:"),(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/upgrading-between-major-mariadb-versions/"},"https://mariadb.com/kb/en/upgrading-between-major-mariadb-versions/"))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you are using a version older than MariaDB 10.1, please update to version\n10.1 first.")),(0,r.kt)("h4",{id:"update-the-centreon-repository"},"Update the Centreon repository"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"This step is required ONLY when your environment features an architecture with\na dedicated remote DBMS. If your environment features Centreon Central and\nMariaDB together on the same server, you SHOULD simply skip this step.")),(0,r.kt)("p",null,"Run the following command on the dedicated DBMS server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y https://yum.centreon.com/standard/22.10/el7/stable/noarch/RPMS/centreon-release-22.10-1.el7.centos.noarch.rpm\n")),(0,r.kt)("h4",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"innodb_additional_mem_pool_size")," parameter has been removed since MariaDB 10.2, so you should remove it\nfrom file ",(0,r.kt)("strong",{parentName:"p"},"/etc/my.cnf.d/centreon.cnf")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-diff"},"#\n# Custom MySQL/MariaDB server configuration for Centreon\n#\n[server]\ninnodb_file_per_table=1\n\nopen_files_limit = 32000\n\nkey_buffer_size = 256M\nsort_buffer_size = 32M\njoin_buffer_size = 4M\nthread_cache_size = 64\nread_buffer_size = 512K\nread_rnd_buffer_size = 256K\nmax_allowed_packet = 8M\n\n# For 4 Go Ram\n-#innodb_additional_mem_pool_size=512M\n#innodb_buffer_pool_size=512M\n\n# For 8 Go Ram\n-#innodb_additional_mem_pool_size=1G\n#innodb_buffer_pool_size=1G\n")),(0,r.kt)("h4",{id:"upgrading-mariadb"},"Upgrading MariaDB"),(0,r.kt)("p",null,"You have to uninstall then reinstall MariaDB to upgrade between major versions (i.e. to switch from version 10.1 to version 10.5)."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Stop the mariadb service:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl stop mariadb\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Uninstall the current version:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"rpm --erase --nodeps --verbose MariaDB-server MariaDB-client MariaDB-shared MariaDB-compat MariaDB-common\n")),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"During this uninstallation step, you may encounter an error because one or several MariaDB packages are missing. In that case, you have to execute the uninstallation command without including the missing package.")),(0,r.kt)("p",{parentName:"li"},"  For instance, you get the following error message:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"package MariaDB-compat is not installed\n")),(0,r.kt)("p",{parentName:"li"},"  As ",(0,r.kt)("strong",{parentName:"p"},"MariaDB-compat")," is the missing package, please execute the same command without quoting ",(0,r.kt)("strong",{parentName:"p"},"MariaDB-compat"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"rpm --erase --nodeps --verbose MariaDB-server MariaDB-client MariaDB-shared MariaDB-common\n")),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"Make sure you have ",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/upgrade/upgrade-from-3-4#install-the-mariadb-repository"},"installed the official MariaDB repository")," before you continue the procedure."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install the 10.5 version:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install MariaDB-server-10.5\\* MariaDB-client-10.5\\* MariaDB-shared-10.5\\* MariaDB-compat-10.5\\* MariaDB-common-10.5\\*\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Start the mariadb service:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl start mariadb\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Launch the MariaDB upgrade process:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"mysql_upgrade\n")),(0,r.kt)("p",{parentName:"li"},"If your database is password-protected, enter:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"mysql_upgrade -u <database_admin_user> -p\n")),(0,r.kt)("p",{parentName:"li"},"Example: if your database_admin_user is ",(0,r.kt)("inlineCode",{parentName:"p"},"root"),", enter:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"mysql_upgrade -u root -p\n")),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"Refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/mysql_upgrade/"},"official documentation"),"\nfor more information or if errors occur during this last step.")))),(0,r.kt)("h4",{id:"enable-mariadb-on-startup"},"Enable MariaDB on startup"),(0,r.kt)("p",null,"Execute the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl enable mariadb\n")),(0,r.kt)("h3",{id:"change-the-format-of-the-tables"},"Change the format of the tables"),(0,r.kt)("p",null,"All tables must be in dynamic format. To know the type of tables, run the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'mysql -u root\nSELECT table_schema,table_name,row_format FROM information_schema.tables WHERE table_schema IN ("centreon", "centreon_storage") ORDER BY table_schema;\n')),(0,r.kt)("p",null,"Then exit mariadb."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"exit\n")),(0,r.kt)("p",null,"To change the type of tables for the ",(0,r.kt)("strong",{parentName:"p"},"centreon")," database, run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'mysql --batch --skip-column-names --execute \'SELECT CONCAT("ALTER TABLE `", table_name, "` ROW_FORMAT=dynamic;") AS aQuery FROM information_schema.tables WHERE table_schema = "centreon" AND row_format IS NOT NULL AND row_format NOT IN ("Dynamic")\' | mysql centreon\n')),(0,r.kt)("p",null,"To change the type of tables for the ",(0,r.kt)("strong",{parentName:"p"},"centreon_storage")," database, run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'mysql --batch --skip-column-names --execute \'SELECT CONCAT("ALTER TABLE `", table_name, "` ROW_FORMAT=dynamic;") AS aQuery FROM information_schema.tables WHERE table_schema = "centreon_storage" AND row_format IS NOT NULL AND row_format NOT IN ("Dynamic")\' | mysql centreon_storage\n')),(0,r.kt)("h3",{id:"synchronize-the-plugins"},"Synchronize the plugins"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Centreon Web 22.10 resource $USER1$ actually points to\n/usr/lib64/nagios/plugins.")),(0,r.kt)("p",null,"To mitigate this issue run the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"mv /usr/lib64/nagios/plugins/* /usr/lib/nagios/plugins/\nrmdir /usr/lib64/nagios/plugins/\nln -s -t /usr/lib64/nagios/ /usr/lib/nagios/plugins/\n")),(0,r.kt)("p",null,"You now have a symbolic link as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ ls -alt /usr/lib64/nagios/\nlrwxrwxrwx   1 root root      24  1 nov.  17:59 plugins -> /usr/lib/nagios/plugins/\n-rwxr-xr-x   1 root root 1711288  6 avril  2018 cbmod.so\n")),(0,r.kt)("h3",{id:"finalizing-the-upgrade"},"Finalizing the upgrade"),(0,r.kt)("p",null,"Before starting the web upgrade process, reload the Apache server with the\nfollowing command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl reload httpd24-httpd\n")),(0,r.kt)("p",null,"Then log on to the Centreon web interface to continue the upgrade process:"),(0,r.kt)("p",null,"Click on ",(0,r.kt)("strong",{parentName:"p"},"Next"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(960769).Z,width:"650",height:"300"})),(0,r.kt)("p",null,"Click on ",(0,r.kt)("strong",{parentName:"p"},"Next"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(734347).Z,width:"650",height:"300"})),(0,r.kt)("p",null,"The release notes describe the main changes. Click on ",(0,r.kt)("strong",{parentName:"p"},"Next"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(151812).Z,width:"650",height:"300"})),(0,r.kt)("p",null,"This process performs the various upgrades. Click on ",(0,r.kt)("strong",{parentName:"p"},"Next"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(633513).Z,width:"650",height:"300"})),(0,r.kt)("p",null,"Your Centreon server is now up to date. Click on ",(0,r.kt)("strong",{parentName:"p"},"Finish")," to access the login\npage:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(862788).Z,width:"650",height:"300"})),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"As the interface layout has changed in version 22.10, you need to clear your browser cache to display the new theme.")),(0,r.kt)("h3",{id:"post-upgrade-actions"},"Post-upgrade actions"),(0,r.kt)("h4",{id:"upgrade-extensions"},"Upgrade extensions"),(0,r.kt)("p",null,"From ",(0,r.kt)("strong",{parentName:"p"},"Administration > Extensions > Manager"),", upgrade all extensions, starting\nwith the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"License Manager,"),(0,r.kt)("li",{parentName:"ul"},"Plugin Packs Manager,"),(0,r.kt)("li",{parentName:"ul"},"Auto Discovery.")),(0,r.kt)("p",null,"Then you can upgrade all other commercial extensions."),(0,r.kt)("h4",{id:"start-the-tasks-manager"},"Start the tasks manager"),(0,r.kt)("p",null,"Since 20.04, Centreon has changed its tasks manager from ",(0,r.kt)("em",{parentName:"p"},"Centcore")," to ",(0,r.kt)("em",{parentName:"p"},"Gorgone"),"."),(0,r.kt)("p",null,"To act this change, run the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl stop centcore\nsystemctl enable gorgoned\nsystemctl start gorgoned\n")),(0,r.kt)("p",null,"Engine statistics that have been collected by ",(0,r.kt)("em",{parentName:"p"},"Centcore")," will know be collected\nby ",(0,r.kt)("em",{parentName:"p"},"Gorgone"),"."),(0,r.kt)("p",null,"Change the rights on the statistics RRD files by running the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"chown -R centreon-gorgone /var/lib/centreon/nagios-perf/*\n")),(0,r.kt)("h4",{id:"remove-failover-name-from-the-broker-outputs-configuration"},'Remove "Failover name" from the broker outputs\' configuration'),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"In older versions of Centreon, the broker retention mechanism that stored monitoring data in temporary files when a network outage occurred used to require manual configuration.\nSince Centreon 3.4 this is not necessary anymore, and in more recent versions ",(0,r.kt)("strong",{parentName:"p"},"it may cause broker not to work at all"),".")),(0,r.kt)("p",null,"Go to ",(0,r.kt)("strong",{parentName:"p"},"Configuration > Pollers > Broker configuration")," and empty the value of the ",(0,r.kt)("strong",{parentName:"p"},"Failover name")," parameter for each output of each broker configuration item."),(0,r.kt)("h4",{id:"restart-monitoring-processes"},"Restart monitoring processes"),(0,r.kt)("p",null,"Centreon Broker component has changed its configuration file format."),(0,r.kt)("p",null,"It now uses JSON instead of XML."),(0,r.kt)("p",null,"To make sure Broker and Engine's Broker module are using new configuration files,\nfollow this steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Deploy Central's configuration from the Centreon web UI by following\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/monitoring/monitoring-servers/deploying-a-configuration"},"this procedure"),",")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Restart both Broker and Engine on the Central server by running this\ncommand:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart cbd centengine\n")))),(0,r.kt)("h2",{id:"upgrade-the-pollers"},"Upgrade the Pollers"),(0,r.kt)("h3",{id:"update-the-centreon-repository-1"},"Update the Centreon repository"),(0,r.kt)("p",null,"Run the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum install -y https://yum.centreon.com/standard/22.10/el7/stable/noarch/RPMS/centreon-release-22.10-1.el7.centos.noarch.rpm\n")),(0,r.kt)("h3",{id:"upgrade-the-centreon-solution-1"},"Upgrade the Centreon solution"),(0,r.kt)("p",null,"Clean yum cache:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum clean all --enablerepo=*\n")),(0,r.kt)("p",null,"Upgrade all the components with the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yum update centreon\\*\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Accept new GPG keys from the repositories as needed.")),(0,r.kt)("p",null,"Start and enable ",(0,r.kt)("strong",{parentName:"p"},"gorgoned"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl start gorgoned\nsystemctl enable gorgoned\n")),(0,r.kt)("p",null,"Restart ",(0,r.kt)("strong",{parentName:"p"},"centengine"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart centengine\n")),(0,r.kt)("p",null,"If the Centreon BAM module is installed, refer to the\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/service-mapping/upgrade"},"upgrade procedure"),"."),(0,r.kt)("h3",{id:"post-upgrade-actions-1"},"Post-upgrade actions"),(0,r.kt)("p",null,"Due to new configuration file format for Engine's Broker module, the\nconfiguration needs to be re-deployed."),(0,r.kt)("p",null,"Deploy Poller's configuration from the Centreon web UI by following\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/monitoring/monitoring-servers/deploying-a-configuration"},"this procedure"),",\nand choose ",(0,r.kt)("strong",{parentName:"p"},"Restart")," method for Engine process."),(0,r.kt)("h2",{id:"migrate-centreon-poller-display-to-remote-server"},"Migrate Centreon Poller Display to Remote Server"),(0,r.kt)("p",null,"If the platform has Pollers with Poller Display module installed, refer to the\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/migrate/poller-display-to-remote-server"},"Migrate a platform with Poller Display\nmodule")," procedure."),(0,r.kt)("h2",{id:"communications"},"Communications"),(0,r.kt)("p",null,"By default, the communication between Central and Pollers or Remote Servers\nwill still be using SSH protocol."),(0,r.kt)("p",null,"Consider changing the communication protocol by following the\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/monitoring/monitoring-servers/communications#change-communication-from-ssh-to-zmq"},"Change communication from SSH to ZMQ"),"\nprocedure."),(0,r.kt)("h2",{id:"secure-your-platform"},"Secure your platform"),(0,r.kt)("p",null,"Don't forget to secure your Centreon platform following our\n",(0,r.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/pr-2587/docs/22.10/administration/secure-platform"},"recommendations")))}h.isMDXComponent=!0},960769:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/web_update_1-229784d5ed7986045c49b65b99ce38cd.png"},734347:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/web_update_2-f12be23b17ba9e83853cbdbaaea65402.png"},151812:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/web_update_3-d505e49a3b4f60dfd887ff45ddbf006b.png"},633513:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/web_update_4-97901eb976096c68fb2bd9d37c4de9bc.png"},862788:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/web_update_5-01f8c54614c006d7c1bf9e03799c1b81.png"}}]);