"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[6872],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>h});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),p=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(r),d=a,h=u["".concat(l,".").concat(d)]||u[d]||m[d]||o;return r?n.createElement(h,i(i({ref:t},c),{},{components:r})):n.createElement(h,i({ref:t},c))}));function h(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=r[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},48310:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>p,toc:()=>u});r(67294);var n=r(3905);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}const s={id:"sql-proxy",title:"Optimizing database traffic"},l=void 0,p={unversionedId:"administration/sql-proxy",id:"version-23.10/administration/sql-proxy",title:"Optimizing database traffic",description:"This procedure concerns very large production environments with numerous users, that face interface response time issues.",source:"@site/versioned_docs/version-23.10/administration/sql-proxy.md",sourceDirName:"administration",slug:"/administration/sql-proxy",permalink:"/centreon-documentation/pr-preview/staging/pr-2763/docs/administration/sql-proxy",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/versioned_docs/version-23.10/administration/sql-proxy.md",tags:[],version:"23.10",lastUpdatedAt:1698401163,formattedLastUpdatedAt:"Oct 27, 2023",frontMatter:{id:"sql-proxy",title:"Optimizing database traffic"},sidebar:"version-23.10/docs",previous:{title:"Configuring your Centreon to send emails",permalink:"/centreon-documentation/pr-preview/staging/pr-2763/docs/administration/postfix"},next:{title:"Update a Centreon 23.10 platform",permalink:"/centreon-documentation/pr-preview/staging/pr-2763/docs/update/update-centreon-platform"}},c={},u=[{value:"Installation",id:"installation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Proxy SQL",id:"proxy-sql",level:3},{value:"Centreon",id:"centreon",level:3}],m={toc:u},d="wrapper";function h(e){var{components:t}=e,s=i(e,["components"]);return(0,n.kt)(d,o(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){a(e,t,r[t])}))}return e}({},m,s),{components:t,mdxType:"MDXLayout"}),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"This procedure concerns very large production environments with numerous users, that face interface response time issues.")),(0,n.kt)("p",null,"When the Centreon platform monitors numerous services and the web application places heavy demands on the real-time database, Broker may have difficulty recording all the metrics. This will create retention files, resulting in a delay between the receipt of new statuses and their availability in the web interface."),(0,n.kt)("p",null,"The aim of this procedure is to reduce the database load by redirecting part of the requests to a second database server."),(0,n.kt)("p",null,"The aim is to relieve the real-time database (",(0,n.kt)("strong",{parentName:"p"},"centreon_storage"),") and avoid Broker retention. All read queries (SELECT) to the real-time database will be redirected to the replicated database."),(0,n.kt)("p",null,"The minimal use case consists in setting up database replication. To ensure proper routing, we will install an SQLproxy server between the Centreon platform and the databases."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"image",src:r(57439).Z,width:"812",height:"540"})),(0,n.kt)("p",null,"Your architecture will contain the three following elements:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"a central server, with ProxySQL installed on it"),(0,n.kt)("li",{parentName:"ul"},"the main database (which will be a remote database, as this is a high-volume platform)"),(0,n.kt)("li",{parentName:"ul"},"a secondary database.")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"In the event of failure, ProxySQL will not be able to handle database failover automatically, and your site will no longer be functional, so it is up to you to set up a failover strategy.\nYou'll need to redirect all SQL queries to your new SQL Master server as quickly as possible, while your incident is being resolved.")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"We strongly recommend using FQDNs rather than fixed IP addresses.")),(0,n.kt)("h2",{id:"installation"},"Installation"),(0,n.kt)("p",null,"To make it possible to distribute queries, we'll be using ",(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/"},"ProxySQL"),"."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"On the central server, ",(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/documentation/installing-proxysql/"},"download and install")," the correct version of ProxySQL for your OS.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Start the service :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"service proxysql start\n")))),(0,n.kt)("h2",{id:"configuration"},"Configuration"),(0,n.kt)("h3",{id:"proxy-sql"},"Proxy SQL"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"On the central server, connect to ProxySQL (the default password is ",(0,n.kt)("strong",{parentName:"p"},"admin"),"):"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mysql -h127.0.0.1 -uadmin -P6032 -p\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"In ProxySQL, define the IP addreses for the two SQL servers (Master & Slave). As a reminder, the Slave SQL server will receive all read queries (SELECT) related to real-time data."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (0, ip_SQL_server_master);\nINSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (1, ip_SQL_server_slave);\n")),(0,n.kt)("p",{parentName:"li"},"Example :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'INSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (0, "192.168.0.2");\nINSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (1, "192.168.0.3");\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Create the user who will connect to both servers. This user must be identical on ProxySQL and on your two databases."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_users (default_hostgroup, username, password) VALUES (0, SQL_user_login, SQL_user_password);\n")),(0,n.kt)("p",{parentName:"li"},"Example :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'INSERT INTO mysql_users (default_hostgroup, username, password) VALUES (0, "centreon", "centreon");\n')),(0,n.kt)("p",{parentName:"li"},"(The value ",(0,n.kt)("strong",{parentName:"p"},"0")," assigned to the ",(0,n.kt)("strong",{parentName:"p"},"default_hostgroup")," property corresponds to the index of the SQL Master server. This indicates the default destination server for all SQL queries.)")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Specify which SQL queries should be redirected to the SQL Slave server:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (1, 1, '.*? AS REALTIME.*', 1,1);\nINSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (2, 1, '^SELECT.*FOUND_ROWS\\(\\).*AS.*REALTIME$', 1,1);\n")),(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Explanation"),": All real-time queries that can be routed by the proxy server contain the ",(0,n.kt)("strong",{parentName:"p"},"REALTIME")," keyword. The above queries contain regexes to identify real-time requests coming from Centreon."),(0,n.kt)("p",{parentName:"li"},"(The value ",(0,n.kt)("strong",{parentName:"p"},"1")," assigned to the ",(0,n.kt)("strong",{parentName:"p"},"destination_hostgroup")," property corresponds to the index of the previously defined server (SQL Slave server). This indicates the destination server for all real-time SQL queries.)")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Run the following commands so that ProxySQL takes the new configuration into account."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"LOAD MYSQL SERVERS TO RUNTIME;\nLOAD MYSQL USERS TO RUNTIME;\nLOAD MYSQL QUERY RULES TO RUNTIME;\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Save the configuration so that it is retained if the ProxySQL server is restarted."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"SAVE MYSQL SERVERS TO DISK;\nSAVE MYSQL USERS TO DISK;\nSAVE MYSQL QUERY RULES TO DISK;\n")))),(0,n.kt)("h3",{id:"centreon"},"Centreon"),(0,n.kt)("p",null,"Once the ProxySQL server has been correctly configured, modify the Centreon configuration so that all queries go through ProxySQL."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Make a backup of the ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php")," file.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Open ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php"),", then change the IP addresses for the two databases, and the connection port."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$conf_centreon['hostCentreon'] = ip_serveur_proxy;\n$conf_centreon['hostCentstorage'] = ip_serveur_proxy;\n$conf_centreon['port'] = \"6033\";\n")))),(0,n.kt)("p",null,"Example :"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$conf_centreon['hostCentreon'] = \"127.0.0.1\";\n$conf_centreon['hostCentstorage'] = \"127.0.0.1\";\n$conf_centreon['port'] = \"6033\";\n")))}h.isMDXComponent=!0},57439:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/sql_proxy-51c4890dbb018a3ff398484644249b97.png"}}]);