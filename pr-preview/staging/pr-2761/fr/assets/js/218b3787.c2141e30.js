"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[6695],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>f});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var i=n.createContext({}),p=function(e){var t=n.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(r),m=a,f=c["".concat(i,".").concat(m)]||c[m]||d[m]||s;return r?n.createElement(f,o(o({ref:t},u),{},{components:r})):n.createElement(f,o({ref:t},u))}));function f(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=r.length,o=new Array(s);o[0]=m;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l[c]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<s;p++)o[p]=r[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},23043:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>f,frontMatter:()=>l,metadata:()=>p,toc:()=>c});r(67294);var n=r(3905);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)r=s[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}const l={id:"sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es"},i=void 0,p={unversionedId:"administration/sql-proxy",id:"version-23.10/administration/sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es",description:"Cette proc\xe9dure concerne les tr\xe8s gros environnements de production avec de nombreux utilisateurs, devant faire face \xe0 des probl\xe8mes de temps de r\xe9ponse de l'interface.",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/sql-proxy.md",sourceDirName:"administration",slug:"/administration/sql-proxy",permalink:"/centreon-documentation/pr-preview/staging/pr-2761/fr/docs/administration/sql-proxy",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/sql-proxy.md",tags:[],version:"23.10",lastUpdatedAt:1698351273,formattedLastUpdatedAt:"26 oct. 2023",frontMatter:{id:"sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es"},sidebar:"version-23.10/docs",previous:{title:"Configurer l'envoi d'emails",permalink:"/centreon-documentation/pr-preview/staging/pr-2761/fr/docs/administration/postfix"},next:{title:"Mise \xe0 jour d'une plateforme Centreon 23.10",permalink:"/centreon-documentation/pr-preview/staging/pr-2761/fr/docs/update/update-centreon-platform"}},u={},c=[{value:"Installation",id:"installation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"ProxySQL",id:"proxysql",level:3},{value:"Centreon",id:"centreon",level:3}],d={toc:c},m="wrapper";function f(e){var{components:t}=e,l=o(e,["components"]);return(0,n.kt)(m,s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){a(e,t,r[t])}))}return e}({},d,l),{components:t,mdxType:"MDXLayout"}),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Cette proc\xe9dure concerne les tr\xe8s gros environnements de production avec de nombreux utilisateurs, devant faire face \xe0 des probl\xe8mes de temps de r\xe9ponse de l'interface.")),(0,n.kt)("p",null,"Lorsque la plateforme Centreon supervise de nombreux services et que l\u2019application web sollicite fortement la base de donn\xe9es temps-r\xe9el, Broker peut avoir du mal \xe0 enregistrer l\u2019ensemble des m\xe9triques. Cela aura pour effet de cr\xe9er des fichiers de r\xe9tention, entra\xeenant ainsi un d\xe9lai entre la r\xe9ception des nouveaux statuts et leur disponibilit\xe9 dans l\u2019interface web."),(0,n.kt)("p",null,"Cette proc\xe9dure a pour but de permettre une r\xe9duction de charge de la base de donn\xe9es en redirigeant une partie des requ\xeates vers un second serveur de bases de donn\xe9es."),(0,n.kt)("p",null,"L\u2019objectif est de soulager la base de donn\xe9es temps-r\xe9el (",(0,n.kt)("strong",{parentName:"p"},"centreon_storage"),") pour \xe9viter \xe0 Broker de faire de la r\xe9tention. Toutes les requ\xeates de lecture (SELECT) \xe0 destination de la base de donn\xe9es temps-r\xe9el seront redirig\xe9es vers la base de donn\xe9es r\xe9pliqu\xe9e."),(0,n.kt)("p",null,"Le cas d\u2019usage minimal consiste \xe0 mettre en place une r\xe9plication des bases de donn\xe9es. Pour assurer correctement ce routage, nous installerons entre la plateforme Centreon et les bases de donn\xe9es un serveur ",(0,n.kt)("strong",{parentName:"p"},"ProxySQL"),"."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"image",src:r(70876).Z,width:"812",height:"540"})),(0,n.kt)("p",null,"Votre architecture contiendra les 3 \xe9l\xe9ments suivants :"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"un serveur central Centreon, et ProxySQL install\xe9 sur celui-ci"),(0,n.kt)("li",{parentName:"ul"},"la base de donn\xe9es principale (qui sera une base de donn\xe9es d\xe9port\xe9e puisqu'il s'agit d'une plateforme \xe0 haute volum\xe9trie)"),(0,n.kt)("li",{parentName:"ul"},"une base de donn\xe9es secondaire.")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Attention : en cas de d\xe9faillance, ProxySQL ne pourra pas g\xe9rer le basculement de base de donn\xe9es automatiquement et votre site ne sera plus fonctionnel, c'est donc \xe0 vous de mettre en place une strat\xe9gie de tol\xe9rance aux pannes.\nIl faudra vous assurer de rediriger au plus vite l'ensemble des requ\xeates SQL vers votre nouveau serveur SQL Master le temps de la r\xe9solution de votre incident.")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Il est fortement conseill\xe9 d'utiliser des FQDN plut\xf4t que des adresses IP fixes.")),(0,n.kt)("h2",{id:"installation"},"Installation"),(0,n.kt)("p",null,"Afin de permettre la r\xe9partition des requ\xeates, nous utiliserons le logiciel ",(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/"},"ProxySQL"),"."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Sur votre serveur central, ",(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/documentation/installing-proxysql/"},"t\xe9l\xe9chargez puis installez")," la version de ProxySQL correspondant \xe0 votre OS.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"D\xe9marrez le service :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"service proxysql start\n")))),(0,n.kt)("h2",{id:"configuration"},"Configuration"),(0,n.kt)("h3",{id:"proxysql"},"ProxySQL"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Sur le serveur central, connectez-vous \xe0 ProxySQL (le mot de passe par defaut est ",(0,n.kt)("strong",{parentName:"p"},"admin"),"):"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mysql -h127.0.0.1 -uadmin -P6032 -p\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"D\xe9finissez dans ProxySQL les adresses IP des deux serveurs SQL, Master & Slave. Pour rappel, le serveur SQL Slave sera destin\xe9 \xe0 recevoir l'ensemble des requ\xeates de lecture (SELECT) li\xe9es aux donn\xe9es temps-r\xe9el."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (0, ip_SQL_server_master);\nINSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (1, ip_SQL_server_slave);\n")),(0,n.kt)("p",{parentName:"li"},"Exemple :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'INSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (0, "192.168.0.2");\nINSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (1, "192.168.0.3");\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Cr\xe9ez l'utilisateur qui se connectera aux deux serveurs. Cet utilisateur doit \xeatre identique sur ProxySQL et sur vos deux bases de donn\xe9es."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_users (default_hostgroup, username, password) VALUES (0, SQL_user_login, SQL_user_password);\n")),(0,n.kt)("p",{parentName:"li"},"Exemple :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'INSERT INTO mysql_users (default_hostgroup, username, password) VALUES (0, "centreon", "centreon");\n')),(0,n.kt)("p",{parentName:"li"},"(La valeur ",(0,n.kt)("strong",{parentName:"p"},"0")," attribu\xe9e \xe0 la propri\xe9t\xe9 ",(0,n.kt)("strong",{parentName:"p"},"default_hostgroup")," correspond \xe0 l'index du serveur SQL Master. Cela permet d'indiquer quel sera le serveur de destination par d\xe9faut pour l'ensemble des requ\xeates SQL.)")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"D\xe9finissez quelles requ\xeates SQL doivent \xeatre redirig\xe9es vers le serveur SQL Slave :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (1, 1, '.*? AS REALTIME.*', 1,1);\nINSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (2, 1, '^SELECT.*FOUND_ROWS\\(\\).*AS.*REALTIME$', 1,1);\n")),(0,n.kt)("p",{parentName:"li"},(0,n.kt)("strong",{parentName:"p"},"Explication")," : Toutes les requ\xeates temps-r\xe9el pouvant \xeatre rout\xe9es par le serveur proxy contiennent le mot clef ",(0,n.kt)("strong",{parentName:"p"},"REALTIME"),". Les requ\xeates ci-dessus contiennent des regex permettant d'identifier les requ\xeates temps-r\xe9el en provenance de Centreon."),(0,n.kt)("p",{parentName:"li"},"(La valeur ",(0,n.kt)("strong",{parentName:"p"},"1")," attribu\xe9e \xe0 la propri\xe9t\xe9 ",(0,n.kt)("strong",{parentName:"p"},"destination_hostgroup")," correspond \xe0 l'index du serveur serveur SQL Slave. Cela permet d'indiquer quel sera le serveur de destination pour l'ensemble des requ\xeates SQL de type temps-r\xe9el.)")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Ex\xe9cutez les commandes suivantes afin que ProxySQL prenne en compte la nouvelle configuration."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"LOAD MYSQL SERVERS TO RUNTIME;\nLOAD MYSQL USERS TO RUNTIME;\nLOAD MYSQL QUERY RULES TO RUNTIME;\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Sauvegardez la configuration afin qu\u2019elle soit prise en compte si le serveur ProxySQL red\xe9marrait."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"SAVE MYSQL SERVERS TO DISK;\nSAVE MYSQL USERS TO DISK;\nSAVE MYSQL QUERY RULES TO DISK;\n")))),(0,n.kt)("h3",{id:"centreon"},"Centreon"),(0,n.kt)("p",null,"Une fois le serveur ProxySQL correctement configur\xe9, modifiez la configuration de Centreon afin de faire passer toutes les requ\xeates par ProxySQL :"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Faites une sauvegarde du fichier ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php"),".")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Ouvrez le fichier ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php"),", puis modifiez l'adresse des bases de donn\xe9es ainsi que le port de connexion."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$conf_centreon['hostCentreon'] = ip_serveur_proxy;\n$conf_centreon['hostCentstorage'] = ip_serveur_proxy;\n$conf_centreon['port'] = \"6033\";\n")))),(0,n.kt)("p",null,"Exemple :"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$conf_centreon['hostCentreon'] = \"127.0.0.1\";\n$conf_centreon['hostCentstorage'] = \"127.0.0.1\";\n$conf_centreon['port'] = \"6033\";\n")))}f.isMDXComponent=!0},70876:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/sql_proxy-51c4890dbb018a3ff398484644249b97.png"}}]);