"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[66695],{3905:(e,r,t)=>{t.d(r,{Zo:()=>p,kt:()=>f});var n=t(67294);function s(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?a(Object(t),!0).forEach((function(r){s(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function l(e,r){if(null==e)return{};var t,n,s=function(e,r){if(null==e)return{};var t,n,s={},a=Object.keys(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||(s[t]=e[t]);return s}(e,r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var i=n.createContext({}),u=function(e){var r=n.useContext(i),t=r;return e&&(t="function"==typeof e?e(r):o(o({},r),e)),t},p=function(e){var r=u(e.components);return n.createElement(i.Provider,{value:r},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},m=n.forwardRef((function(e,r){var t=e.components,s=e.mdxType,a=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(t),m=s,f=c["".concat(i,".").concat(m)]||c[m]||d[m]||a;return t?n.createElement(f,o(o({ref:r},p),{},{components:t})):n.createElement(f,o({ref:r},p))}));function f(e,r){var t=arguments,s=r&&r.mdxType;if("string"==typeof e||s){var a=t.length,o=new Array(a);o[0]=m;var l={};for(var i in r)hasOwnProperty.call(r,i)&&(l[i]=r[i]);l.originalType=e,l[c]="string"==typeof e?e:s,o[1]=l;for(var u=2;u<a;u++)o[u]=t[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},23043:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>p,contentTitle:()=>i,default:()=>f,frontMatter:()=>l,metadata:()=>u,toc:()=>c});t(67294);var n=t(3905);function s(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(e,r){return r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):function(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})),e}function o(e,r){if(null==e)return{};var t,n,s=function(e,r){if(null==e)return{};var t,n,s={},a=Object.keys(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||(s[t]=e[t]);return s}(e,r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}const l={id:"sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es"},i=void 0,u={unversionedId:"administration/sql-proxy",id:"version-23.10/administration/sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es",description:"Cette proc\xe9dure concerne les tr\xe8s gros environnements de production avec de nombreux utilisateurs, devant faire face \xe0 des probl\xe8mes de temps de r\xe9ponse de l'interface.",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/sql-proxy.md",sourceDirName:"administration",slug:"/administration/sql-proxy",permalink:"/centreon-documentation/pr-preview/staging/pr-2744/fr/docs/administration/sql-proxy",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/sql-proxy.md",tags:[],version:"23.10",lastUpdatedAt:1697785047,formattedLastUpdatedAt:"20 oct. 2023",frontMatter:{id:"sql-proxy",title:"Optimiser le trafic vers les bases de donn\xe9es"}},p={},c=[{value:"Installation",id:"installation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Proxy SQL",id:"proxy-sql",level:3},{value:"Centreon",id:"centreon",level:3}],d={toc:c},m="wrapper";function f(e){var{components:r}=e,l=o(e,["components"]);return(0,n.kt)(m,a(function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),n.forEach((function(r){s(e,r,t[r])}))}return e}({},d,l),{components:r,mdxType:"MDXLayout"}),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Cette proc\xe9dure concerne les tr\xe8s gros environnements de production avec de nombreux utilisateurs, devant faire face \xe0 des probl\xe8mes de temps de r\xe9ponse de l'interface.")),(0,n.kt)("p",null,"Lorsque la plateforme Centreon supervise de nombreux services et que l\u2019application web sollicite fortement la base de donn\xe9es temps-r\xe9el, Broker peut avoir du mal \xe0 enregistrer l\u2019ensemble des m\xe9triques. Cela aura pour effet de cr\xe9er des fichiers de r\xe9tention, entra\xeenant ainsi un d\xe9lai entre la r\xe9ception des nouveaux statuts et leur disponibilit\xe9 dans l\u2019interface web."),(0,n.kt)("p",null,"Cette proc\xe9dure a pour but de permettre une r\xe9duction de charge de la base de donn\xe9es en redirigeant une partie des requ\xeates vers un second serveur de bases de donn\xe9es."),(0,n.kt)("p",null,"L\u2019objectif est de soulager la base de donn\xe9es temps-r\xe9el (",(0,n.kt)("strong",{parentName:"p"},"centreon_storage"),") pour \xe9viter \xe0 Broker de faire de la r\xe9tention. Toutes les requ\xeates de lecture (SELECT) \xe0 destination de la base de donn\xe9es temps-r\xe9el seront redirig\xe9es vers la base de donn\xe9es r\xe9pliqu\xe9e."),(0,n.kt)("p",null,"Le cas d\u2019usage minimal consiste \xe0 mettre en place une r\xe9plication des bases de donn\xe9es. Pour assurer correctement ce routage, nous installerons entre la plateforme Centreon et les bases de donn\xe9es un serveur ",(0,n.kt)("strong",{parentName:"p"},"ProxySQL"),"."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"image",src:t(70876).Z,width:"812",height:"540"})),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Dans le cas d'une utilisation avec un cluster de bases de donn\xe9es, il faudra bien veiller \xe0 reconfigurer le serveur ProxySQL lorsque le serveur SQL Master et/ou Slave change d'adresse IP, ou en cas de d\xe9faillance de l'un des serveurs SQL.\nEn cas de d\xe9faillance, ProxySQL ne pourra pas g\xe9rer le basculement de base de donn\xe9es automatiquement et votre site ne sera plus fonctionnel, c'est donc \xe0 vous de mettre en place une strat\xe9gie de tol\xe9rance aux pannes.\nIl faudra vous assurer de rediriger au plus vite l'ensemble des requ\xeates SQL vers votre nouveau serveur SQL Master le temps de la r\xe9solution de votre incident.")),(0,n.kt)("p",null,"Il est fortement conseill\xe9 d'utiliser des FQDN plut\xf4t que des adresses IP fixes."),(0,n.kt)("h2",{id:"installation"},"Installation"),(0,n.kt)("p",null,"Afin de permettre la r\xe9partition des requ\xeates, nous utiliserons le logiciel ",(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/"},"ProxySQL"),". L'installation suivante consid\xe8re que le proxy est install\xe9 sur le serveur Centreon."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",{parentName:"p",href:"https://proxysql.com/documentation/installing-proxysql/"},"T\xe9l\xe9chargez puis installez")," la version correspondant \xe0 votre environnement.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"D\xe9marrez le service :"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"service proxysql start\n")))),(0,n.kt)("h2",{id:"configuration"},"Configuration"),(0,n.kt)("h3",{id:"proxy-sql"},"Proxy SQL"),(0,n.kt)("p",null,"La configuration se fera par l'interm\xe9diaire de l'interface d'administration du proxy.\nPour ce faire, connectez-vous au moyen d'un client MySQL (le mot de passe par defaut est ",(0,n.kt)("strong",{parentName:"p"},"admin"),")."),(0,n.kt)("p",null,"Si vous avez install\xe9 ProxySQL sur un serveur autre que Centreon, modifiez l'adresse IP."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"mysql -h127.0.0.1 -uadmin -P6032 -p\n")),(0,n.kt)("p",null,"Pour commencer, d\xe9finissez les deux serveurs SQL (Master & Slave). Pour rappel, le serveur SQL Slave sera destin\xe9 \xe0 recevoir l'ensemble des requ\xeates de lecture (SELECT) li\xe9es aux donn\xe9es temps-r\xe9el."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (0, ip_SQL_server_master)\nINSERT INTO mysql_servers (hostgroup_id, hostname) VALUES (1, ip_SQL_server_slave)\n")),(0,n.kt)("p",null,"Ensuite, configurez l'utilisateur qui se connectera aux deux serveurs."),(0,n.kt)("p",null,"La valeur ",(0,n.kt)("strong",{parentName:"p"},"0")," attribu\xe9e \xe0 la propri\xe9t\xe9 ",(0,n.kt)("strong",{parentName:"p"},"default_hostgroup")," correspond \xe0 l'index du serveur pr\xe9alablement d\xe9fini (serveur SQL Master).\nCela permet d'indiquer quel sera le serveur de destination par d\xe9faut pour l'ensemble des requ\xeates SQL."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_users (default_hostgroup, username, password) VALUES (0, SQL_user_login, SQL_user_password)\n")),(0,n.kt)("p",null,"Puis, indiquez quelles requ\xeates SQL doivent \xeatre redirig\xe9es vers le serveur SQL Slave.\nToutes les requ\xeates temps-r\xe9el pouvant \xeatre rout\xe9es par le serveur proxy ont \xe9t\xe9 modifi\xe9es afin qu'elles contiennent le mot clef ",(0,n.kt)("strong",{parentName:"p"},"REALTIME"),". L\u2019utilisation de deux regex permet donc leur identification."),(0,n.kt)("p",null,"La valeur ",(0,n.kt)("strong",{parentName:"p"},"1")," attribu\xe9e \xe0 la propri\xe9t\xe9 ",(0,n.kt)("strong",{parentName:"p"},"destination_hostgroup")," correspond \xe0 l'index du serveur pr\xe9alablement d\xe9fini (serveur SQL Slave). Cela permet d'indiquer quel sera le serveur de destination pour l'ensemble des requ\xeates SQL de type temps-r\xe9el."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (1, 1, '.*? AS REALTIME.*', 1,1)\nINSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (2, 1, '^SELECT.*FOUND_ROWS\\(\\).*AS.*REALTIME$', 1,1)\n")),(0,n.kt)("p",null,"Une fois cette \xe9tape termin\xe9e, ex\xe9cutez les commandes suivantes afin que ProxySQL prenne en compte la nouvelle configuration."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"LOAD MYSQL SERVERS TO RUNTIME;\nLOAD MYSQL USERS TO RUNTIME;\nLOAD MYSQL QUERY RULES TO RUNTIME;\n")),(0,n.kt)("p",null,"Sauvegardez la configuration afin qu\u2019elle soit prise en compte si le serveur ProxySQL red\xe9marrait."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"SAVE MYSQL SERVERS TO DISK;\nSAVE MYSQL USERS TO DISK;\nSAVE MYSQL QUERY RULES TO DISK;\n")),(0,n.kt)("h3",{id:"centreon"},"Centreon"),(0,n.kt)("p",null,"Une fois le serveur ProxySQL correctement configur\xe9, il est n\xe9cessaire de modifier la configuration de Centreon afin de changer les param\xe8tres de connexion au serveur de base de donn\xe9es."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Faites une sauvegarde du fichier ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php"),".")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Ouvrez le fichier ",(0,n.kt)("strong",{parentName:"p"},"/etc/centreon/centreon.conf.php"),", puis modifiez l'adresse du serveur SQL ainsi que le port de connexion."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$conf_centreon['hostCentreon'] = ip_serveur_proxy;\n$conf_centreon['hostCentstorage'] = ip_serveur_proxy;\n$conf_centreon['port'] = \"6033\";\n")))))}f.isMDXComponent=!0},70876:(e,r,t)=>{t.d(r,{Z:()=>n});const n=t.p+"assets/images/sql_proxy-51c4890dbb018a3ff398484644249b97.png"}}]);